# 海龟汤在线房间 - 设计文档

## 1. 项目概述

### 1.1 项目名称
海龟汤在线房间 (Sea Turtle Soup Room)

### 1.2 核心理念
本项目旨在创建一个纯前端的网页版海龟汤游戏。采用LeanCloud作为实时数据服务，无需独立后端服务器，可以直接部署在Netlify等静态网站托管平台上。主持人作为房间的"主机"，负责创建游戏、分发邀请并管理游戏进程。

### 1.3 目标用户
希望和朋友们进行一场便捷、无需下载的海龟汤游戏的用户群体。

---

## 2. 功能需求

### 2.1 核心玩法

#### 2.1.1 角色系统
- **主持人 (Host):**
    - 房间的创建者和游戏的核心。
    - 负责设定游戏规则、出题（汤面和汤底，可以是文字或图片）。
    - 获取"邀请码"分享给参与者。
    - 拥有游戏控制权：通过【是】【否】【不确定】按钮回答问题、发布情报、管理提问者、结束游戏。
    - 可以选择结束当前游戏后继续新游戏，重新输入汤面和汤底。
    - 是所有数据广播的中心节点。

- **参与者 (Participant):**
    - 通过主持人分享的"邀请码"加入游戏。
    - 主要操作为向主持人进行文字提问。
    - 拥有独立的个人笔记区，用于记录线索。
    - 可根据规则进行举手、送花等互动。

#### 2.1.2 游戏流程
1.  **创建房间:** 用户选择"创建房间"成为主持人。
2.  **设定规则:** 主持人设定本次游戏的规则，并写下汤面和汤底（可以是文字或上传图片）。
3.  **生成邀请:** 系统为主持人生成一个"邀请码"（包含了房间ID和房间规则）。
4.  **分发邀请:** 主持人通过站外聊天工具将邀请码发送给朋友。
5.  **加入房间:** 参与者在页面粘贴邀请码，点击"加入房间"。
6.  **建立连接:** 参与者通过邀请码找到对应房间并加入，系统自动建立实时连接。
7.  **开始游戏:** 所有玩家就位后，主持人宣布游戏开始。游戏信息（如提问、回答、情报）通过实时数据库同步给所有参与者。
8.  **结束游戏:** 主持人点击"结束游戏"，公布汤底，游戏结束，临时图片数据被删除。
9.  **继续游戏:** 主持人可以选择"继续游戏"，重新设置汤面和汤底，开始新一轮游戏。

#### 2.1.3 规则设定（由主持人创建时确定）
- **提问模式:**
    - **自由模式:** 参与者可随时提问。
    - **举手模式:** 参与者需"举手"申请，由主持人"点名"后方可提问。
- **互动功能:** 允许 / 禁止 参与者之间互丢鲜花或垃圾。

---

### 2.2 用户界面 (UI)

#### 2.2.1 主持人视图
- **房间设置区:** 
    - 用于输入汤面、汤底（文字输入框或图片上传区）。
    - 选择游戏规则。
- **连接管理区:**
    - 显示并一键复制"邀请码"。
    - 已连接的参与者列表。
- **游戏控制区:**
    - 【是】、【否】、【不确定】三个回答按钮。
    - "发布情报"输入框和按钮。
    - "结束游戏"和"继续游戏"按钮。
    - （举手模式下）举手列表和"点名"按钮。
- **聊天记录区:** 显示所有公开的提问、回答和情报。

#### 2.2.2 参与者视图
- **加入房间界面:** 输入"邀请码"的文本框。
- **游戏主界面:**
    - **提问区:** 文字输入框和"发送"按钮。
    - **互动区:** （举手模式下）"举手"按钮；（如规则允许）"送鲜花/垃圾"按钮。
    - **聊天记录区:** 与主持人视图同步。
    - **个人笔记区:** 一个私密的富文本或纯文本区域，用于自由记录。
    - **房间信息区:** 显示当前房间规则和在线玩家列表。

---

## 3. 技术设计

### 3.1 技术栈
- **前端框架:** React.js (用于构建用户界面)
- **样式处理:** TailwindCSS (轻量级CSS框架)
- **状态管理:** React Context API 或 Zustand (轻量级状态管理)
- **实时通信:** LeanCloud 实时数据服务 (国内可用的BaaS服务)
- **认证服务:** 匿名认证 (无需用户注册)
- **部署平台:** Netlify (静态网站托管)

### 3.2 纯前端架构
- **基于BaaS的实时通信:**
    - 使用LeanCloud实时数据服务作为数据同步层
    - 所有客户端直接连接到LeanCloud服务
    - 无需自建后端服务器
    - 使用LeanCloud的ACL权限控制系统保护数据安全

### 3.3 数据结构
LeanCloud数据库的结构设计:

```
Room 表:
  - objectId: 自动生成的唯一ID
  - roomId: 房间ID (用于邀请码)
  - hostId: 主持人用户ID
  - title: 汤面文本
  - titleIsImage: Boolean
  - titleImage: 图片文件或URL (如果使用图片)
  - solution: 汤底文本
  - solutionIsImage: Boolean
  - solutionImage: 图片文件或URL (如果使用图片)
  - rules: Object { freeQuestion: Boolean, allowFlowers: Boolean }
  - status: String ("waiting"|"active"|"ended")
  - createdAt: 自动生成的创建时间
  - updatedAt: 自动生成的更新时间
  - active: Boolean
  - ACL: 访问控制列表

Participant 表:
  - objectId: 自动生成的唯一ID
  - roomId: 关联的房间ID
  - userId: 用户ID
  - nickname: 用户昵称
  - isHost: Boolean
  - joinedAt: 加入时间
  - lastActive: 最后活跃时间
  - ACL: 访问控制列表

Message 表:
  - objectId: 自动生成的唯一ID
  - roomId: 关联的房间ID
  - type: String ("question"|"answer"|"clue"|"interaction")
  - from: 发送者ID
  - fromName: 发送者昵称
  - content: 消息内容
  - createdAt: 自动生成的创建时间
  - ACL: 访问控制列表

GameState 表:
  - objectId: 自动生成的唯一ID
  - roomId: 关联的房间ID
  - status: String ("waiting"|"active"|"ended")
  - handsRaised: Array [用户ID]
  - ACL: 访问控制列表
```

### 3.4 图片处理
- **前端处理流程:**
    1. 客户端将图片转换为Base64编码或使用LeanCloud的文件存储服务
    2. 图片数据存储在LeanCloud的文件存储中
    3. 游戏结束后，清理图片数据
- **优化措施:**
    - 客户端上传前进行图片压缩
    - 设置图片大小限制（如1MB）
    - 使用图片压缩库减小体积
    - 可选择性使用WebP格式提高压缩率

### 3.5 房间管理与安全
- **房间生命周期:**
    - 房间创建后在LeanCloud中注册
    - 活跃房间有TTL (Time To Live)，超时自动清理
    - 主持人可手动关闭房间，触发数据清理
- **数据安全:**
    - 使用LeanCloud的ACL (访问控制列表)限制访问
    - 只有房间成员可以读取房间数据
    - 只有主持人可以修改关键游戏状态
    - 参与者只能添加消息和更新自己的状态

---

## 4. 项目里程碑

### 里程碑一: 核心连接与消息功能 (MVP)
- **目标:** 实现基本的房间创建、加入和消息功能。
- **任务:**
    1. 搭建React前端基础架构
    2. 集成LeanCloud服务
    3. 实现房间创建、生成邀请码功能
    4. 实现通过邀请码加入房间功能
    5. 实现基本的文本消息收发功能

### 里程碑二: 基本游戏逻辑实现
- **目标:** 实现完整的海龟汤游戏流程。
- **任务:**
    1. 实现主持人创建房间、设定规则的UI
    2. 实现基于LeanCloud的实时数据同步
    3. 完成提问、回答、发布情报的核心逻辑
    4. 实现聊天记录区和参与者列表的动态更新
    5. 实现游戏结束和继续游戏逻辑

### 里程碑三: 图片支持与UI优化
- **目标:** 添加图片支持并优化用户体验。
- **任务:**
    1. 实现图片上传、压缩和显示功能
    2. 优化React组件和TailwindCSS样式
    3. 增加个人笔记功能
    4. 实现提问模式（自由/举手）和互动功能（鲜花/垃圾）
    5. 增加断线重连的提示和处理

### 里程碑四: 优化与部署
- **目标:** 完成应用优化和部署。
- **任务:**
    1. 优化应用性能和加载速度
    2. 实现PWA功能，支持离线访问
    3. 配置Netlify部署流程
    4. 进行跨浏览器兼容性测试
    5. 优化LeanCloud使用以控制在免费额度内 